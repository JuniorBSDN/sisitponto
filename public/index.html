<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sistema de Ponto SaaS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --secondary: #64748b;
            --success: #22c55e; --danger: #ef4444; --bg: #f8fafc;
            --sidebar: #0f172a; --card: #ffffff; --text-main: #1e293b; --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); }

        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar); color: white; padding: 1.5rem; flex-shrink: 0; }
        .sidebar-header { margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
        .sidebar-header i { font-size: 1.5rem; color: var(--primary); }
        .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .nav-item { padding: 12px 16px; border-radius: 8px; color: #94a3b8; text-decoration: none; transition: 0.3s; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .nav-item:hover, .nav-item.active { background: #1e293b; color: white; }
        .nav-item.active { border-left: 4px solid var(--primary); }

        .main-content { flex-grow: 1; padding: 2rem; overflow-y: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .btn-add { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }

        .card-container { background: var(--card); border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 16px; text-align: left; font-size: 0.85rem; color: var(--secondary); border-bottom: 1px solid var(--border); }
        td { padding: 16px; border-bottom: 1px solid var(--border); font-size: 0.95rem; }

        .status-pill { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-blocked { background: #fee2e2; color: #991b1b; }

        .action-btns { display: flex; gap: 10px; }
        .btn-icon { background: none; border: none; cursor: pointer; font-size: 1.1rem; transition: 0.2s; }

        /* Modais */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 500px; border-radius: 16px; padding: 2rem; position: relative; }
        .form-group { margin-bottom: 1.2rem; display: flex; flex-direction: column; gap: 6px; }
        .form-group input, .form-group select { padding: 10px; border: 1px solid var(--border); border-radius: 8px; }

        .compliance-box { background: #f8fafc; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--primary); margin: 1rem 0; font-size: 0.8rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>

<div class="dashboard-container">
    <aside class="sidebar">
        <div class="sidebar-header"><i class="fas fa-clock-rotate-left"></i><h2>Ponto<strong>SaaS</strong></h2></div>
        <nav class="sidebar-nav">
            <a onclick="switchTab('empresas')" class="nav-item active" id="nav-empresas"><i class="fas fa-building"></i> Empresas</a>
            <a onclick="switchTab('relatorios')" class="nav-item" id="nav-relatorios"><i class="fas fa-chart-line"></i> Relatórios</a>
        </nav>
    </aside>

    <main class="main-content">
        <section id="tab-empresas">
            <header>
                <h1>Gestão de Empresas</h1>
                <button class="btn-add" onclick="openModal('modalEmpresa')">+ Nova Empresa</button>
            </header>
            <div class="card-container">
                <table>
                    <thead>
                        <tr><th>Empresa / CNPJ</th><th>Plano</th><th>Status Conta</th><th>Ações</th></tr>
                    </thead>
                    <tbody id="lista-clientes">
                        <tr>
                            <td><strong>Farmácia Central</strong><br><small>12.345.678/0001-90</small></td>
                            <td>Pro</td>
                            <td><span class="status-pill status-active">Ativo</span></td>
                            <td class="action-btns">
                                <button class="btn-icon" style="color: #f59e0b;" onclick="gerarQRMestre('ID_TESTE_123', 'Farmácia Central')"><i class="fas fa-qrcode"></i></button>
                                <button class="btn-icon btn-edit" style="color: var(--primary)"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon btn-delete" style="color: var(--danger)"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>
</div>

<div id="modalEmpresa" class="modal">
    <div class="modal-content">
        <h2>Nova Empresa</h2><br>
        <form id="formCliente">
            <div class="form-group"><label>Nome Fantasia</label><input type="text" id="nome" required></div>
            <div class="form-group"><label>CNPJ</label><input type="text" id="cnpj" required></div>
            <div class="form-group">
                <label>Plano</label>
                <select id="plano">
                    <option value="basico">Básico</option>
                    <option value="pro">Pro</option>
                </select>
            </div>
            <div class="compliance-box">
                <label><input type="checkbox" required> Aceito os termos da <strong>Portaria 671/MTE</strong></label>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeModal('modalEmpresa')">Cancelar</button>
                <button type="submit" class="btn-save" style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalQRMestre" class="modal">
    <div class="modal-content" style="text-align: center;">
        <h2>Ativação do Tablet</h2>
        <p id="nome-farmacia-qr" style="margin: 10px 0; font-weight: bold;"></p>
        <div id="qrcode-container" style="margin: 20px auto; display: inline-block; padding: 10px; background: white; border: 1px solid #ddd;"></div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal('modalQRMestre')">Fechar</button>
            <button class="btn-save" onclick="window.print()" style="background:var(--success); color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">Imprimir</button>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://sua-api.vercel.app/api"; // Substitua pela sua URL da Vercel após o deploy

    // Carregar dados ao iniciar
    document.addEventListener('DOMContentLoaded', carregarEmpresas);

    function switchTab(tab) {
        document.getElementById('tab-empresas').style.display = tab === 'empresas' ? 'block' : 'none';
        // Se tivesse uma aba de relatórios, adicionaria a lógica aqui
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('nav-' + tab).classList.add('active');
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- FUNÇÕES DE API ---

    async function carregarEmpresas() {
        try {
            const response = await fetch(`${API_URL}/clientes`);
            const empresas = await response.json();
            const tabela = document.getElementById('lista-clientes');
            tabela.innerHTML = '';

            empresas.forEach(emp => {
                tabela.innerHTML += `
                    <tr>
                        <td><strong>${emp.nome_fantasia}</strong><br><small>${emp.cnpj}</small></td>
                        <td>${emp.plano}</td>
                        <td>
                            <span class="status-pill ${emp.status === 'ativo' ? 'status-active' : 'status-blocked'}">
                                ${emp.status.toUpperCase()}
                            </span>
                        </td>
                        <td class="action-btns">
                            <button class="btn-icon" style="color: #f59e0b;" onclick="gerarQRMestre('${emp.id}', '${emp.nome_fantasia}')" title="Ativar Tablet">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button class="btn-icon" style="color: var(--primary)" onclick="alternarStatus('${emp.id}', '${emp.status}')" title="Bloquear/Desbloquear">
                                <i class="fas fa-ban"></i>
                            </button>
                            <button class="btn-icon btn-delete" style="color: var(--danger)" onclick="excluirEmpresa('${emp.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error("Erro ao carregar empresas:", error);
        }
    }

    document.getElementById('formCliente').addEventListener('submit', async (e) => {
        e.preventDefault();
        const dados = {
            nome: document.getElementById('nome').value,
            cnpj: document.getElementById('cnpj').value,
            plano: document.getElementById('plano').value
        };

        try {
            const response = await fetch(`${API_URL}/clientes`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dados)
            });

            if (response.ok) {
                alert("Empresa cadastrada com sucesso!");
                closeModal('modalEmpresa');
                carregarEmpresas();
            }
        } catch (error) {
            alert("Erro ao salvar empresa.");
        }
    });

    async function alternarStatus(id, statusAtual) {
        const novoStatus = statusAtual === 'ativo' ? 'inadimplente' : 'ativo';
        if(confirm(`Deseja alterar o status para ${novoStatus}?`)) {
            await fetch(`${API_URL}/clientes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: novoStatus })
            });
            carregarEmpresas();
        }
    }

    async function excluirEmpresa(id) {
        if(confirm("Tem certeza que deseja excluir esta empresa permanentemente?")) {
            await fetch(`${API_URL}/clientes/${id}`, { method: 'DELETE' });
            carregarEmpresas();
        }
    }

    function gerarQRMestre(id, nome) {
        document.getElementById('nome-farmacia-qr').innerText = nome;
        const container = document.getElementById('qrcode-container');
        container.innerHTML = "";

        // Payload que o tablet lerá para se configurar
        const payload = btoa(JSON.stringify({ id: id, nome: nome, api: API_URL }));
        new QRCode(container, { text: payload, width: 200, height: 200 });

        openModal('modalQRMestre');
    }

    window.onclick = (e) => { if(e.target.classList.contains('modal')) e.target.style.display = 'none'; }
</script>
</body>
</html>